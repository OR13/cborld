#!/usr/bin/env node
/*!
 * Copyright (c) 2020 Digital Bazaar, Inc. All rights reserved.
 */
const cborld = require('.');
const fs = require('fs');
const fsp = require('fs').promises;
const https = require('https');
const url = require('url');

// FIXME: Remove eventually
async function documentLoader(docUrl) {
  const cacheFile = 'jsonldcontext' + url.parse(docUrl).pathname
    .replace(/\//g, '-').replace(/\.jsonld$/, '') + '.jsonld';

  try {
    await fsp.access(cacheFile, fs.constants.F_OK | fs.constants.R_OK);
  } catch(e) {
    const file = fs.createWriteStream(cacheFile);
    const options = {
      headers: {
        accept: 'application/ld+json'
      }
    };
    await new Promise((resolve, reject) =>
      https.get(docUrl, options, response => {
        response.pipe(file);
        response.on('end', resolve);
        response.on('error', reject);
      })
    );
  }

  return JSON.parse(await fsp.readFile(cacheFile));
}

// Yars command to encode a given JSON-LD document to CBOR-LD
async function encodeCommand(args) {
  try {
    const jsonldBytes = await fsp.readFile(args.file);
    const jsonldDocument = JSON.parse(jsonldBytes);
    const options = {documentLoader, diagnose: args.verbose};
    const cborldBytes = await cborld.encode({jsonldDocument, options});
    await fsp.writeFile('out.cborld', cborldBytes);

    if(args.verbose) {
      const ratio = 100 - (cborldBytes.length / jsonldBytes.length) * 100;
      console.log(`${jsonldBytes.length} JSON-LD input bytes, ` +
        `${cborldBytes.length} CBOR-LD output bytes, ` +
        `${ratio.toFixed(0)}% compression.`);
    }

    console.log(`Wrote CBOR-LD output to '${args.output}'.`);
  } catch(e) {
    console.error(e.stack);
    process.exit(1);
  }
}

async function main() {
  require('yargs')
    .usage('Usage: $0 <command>')
    .option('verbose', {
      describe: 'Provide verbose logging',
      type: 'boolean',
      default: false
    })
    .option('diagnose', {
      describe: 'Provide diagnostic output',
      type: 'boolean',
      default: false
    })
    .alias('h', 'help')
    .help('help', 'Show help for cborld command.')
    .command('encode [options] <file>', 'Encode a JSON-LD file to CBOR-LD',
      yargs => {
        yargs
          .positional('file', {
            describe: 'The JSON-LD file to encode.',
            type: 'string'
          })
          .option('output', {
            describe: 'Write output to filename.',
            alias: 'o',
            type: 'string',
            default: 'out.cborld'
          });
      }, encodeCommand)
    .alias('e', 'encode')
    .argv;
}

main();
