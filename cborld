#!/usr/bin/env node
/*!
 * Copyright (c) 2020 Digital Bazaar, Inc. All rights reserved.
 */
const cborld = require('.');
const fs = require('fs').promises;

// FIXME: Remove eventually
async function documentLoader(url) {
  let result;

  if(url === 'https://www.w3.org/ns/activitystreams') {
    result = JSON.parse(await fs.readFile('activitystreams.jsonld'));
  }

  return result;
}

async function encodeCommand(args) {
  try {
    const jsonldDocument = JSON.parse(await fs.readFile(args.file));
    const options = {documentLoader};
    const cborldBytes = await cborld.encode({jsonldDocument, options});
    console.log('CBOR-LD:', cborldBytes);
  } catch(e) {
    console.error(e.toString());
    process.exit(1);
  }
}

async function main() {
  require('yargs')
    .usage('Usage: $0 <command>')
    .alias('h', 'help')
    .help('help', 'Show help for cborld command.')
    .command('encode [options] <file>', 'Encode a JSON-LD file to CBOR-LD',
      yargs => {
        yargs.positional('file', {
          describe: 'The JSON-LD file to encode.',
          type: 'string'
        });
      }, encodeCommand)
    .alias('e', 'encode')
    .argv;
}

main();
